<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AI å¥èº«æ•™ç·´ - èŠå¤©å ±å‘Š</title>
    <style>
        * {
            font-family: å¾®è»Ÿæ­£é»‘é«”;
        }
        .text-center {
            text-align: center;
            font-weight: 600
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #113F67;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #b9cbd4;
            color: #134a7a;
            font-weight: 600;
        }
        .chat-container {
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 15px;
            display: flex;
            flex-direction: column;
            background-color: #f9f9f9;
        }
        .message-row {
            display: flex;
            margin-bottom: 15px;
        }
        .user-row {
            justify-content: flex-end;
        }
        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 20px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #113F67;
            color: white;
            font-weight: 600;
        }
        .bot-message {
            background-color: #e2e2e2;
            color: #333;
            font-weight: 600;
        }
        #input-area {
            display: flex;
            margin-top: 10px;
        }
        #user-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #send-button {
            padding: 10px 20px;
            margin-left: 10px;
            border: none;
            background-color: #113F67;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h1 class="text-center">{{ username }}çš„æ·±è¹²åˆ†æå ±å‘Š</h1>

    <table>
        <tr>
            <th>index</th>
            <th>æ·±åº¦-å³</th>
            <th>æ·±åº¦-å·¦</th>
            <th>è…³å°–è§’åº¦-å³</th>
            <th>è…³å°–è§’åº¦-å·¦</th>
            <th>è†è“‹èˆ‡è…³å°–å·®ç•°è§’åº¦-å³</th>
            <th>è†è“‹èˆ‡è…³å°–å·®ç•°è§’åº¦-å·¦</th>
            <th>å•é¡Œ</th>
            <th>åˆ†æ•¸ (æ»¿åˆ†100åˆ†)</th>
        </tr>
        {% set report_table = report_json | from_json %}
        {% for row in report_table %}
        <tr>
            <td>{{ row.index }}</td>
            <td>{{ row.right_depth }}</td>
            <td>{{ row.left_depth }}</td>
            <td>{{ row.right_foot_angle_3d }}</td>
            <td>{{ row.left_foot_angle_3d }}</td>
            <td>{{ row.right_diff }}</td>
            <td>{{ row.left_diff }}</td>
            <td>{{ row.issues }}</td>
            <td>{{ row.total_score }}</td>
        </tr>
        {% endfor %}
    </table>
    <p>æ¬¡æ•¸: {{ squat_count }}ï¼Œå¹³å‡åˆ†æ•¸: {{ average_score }}åˆ†</p>
    <hr style="margin: 40px 0;">
    <h2>AI å¥èº«æ•™ç·´çš„ç¸½çµ</h2>
    <p style="margin-bottom: 5px;">
    ğŸ’¡å°åˆ†æå ±å‘Šæœ‰ä»»ä½•ç–‘å•ï¼Œæ­¡è¿éš¨æ™‚åœ¨ä¸‹æ–¹è¼¸å…¥æ¡†æå•ï¼
    ä¾‹å¦‚ï¼šã€Œè†è“‹å…§å¤¾æ€éº¼æ”¹å–„ï¼Ÿã€æˆ–ã€Œé‡å¿ƒç©©å®šæœ‰ä»€éº¼ç§˜è¨£ï¼Ÿã€
    </p>
    <div class="chat-container" id="messages-container">
        </div>
    
    <div id="input-area">
        <input type="text" id="user-input" placeholder="å°æ·±è¹²å ±å‘Šæœ‰ç–‘å•å—ï¼Ÿ">
        <button id="send-button">ç™¼é€</button>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        let conversationId = null;
        const userId = '{{ username }}'; 

        function addMessage(text, sender) {
            const messageRow = document.createElement('div');
            messageRow.classList.add('message-row');
            if (sender === 'user') {
                messageRow.classList.add('user-row');
            }
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', `${sender}-message`);
            messageDiv.textContent = text;
            messageRow.appendChild(messageDiv);
            messagesContainer.appendChild(messageRow);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendToBackend(message) {
            const payload = {
                message: message,
                user_id: userId,
                conversation_id: conversationId
            };
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                
                if (response.ok) {
                    if (!conversationId) {
                        conversationId = data.conversation_id;
                    }
                    addMessage(data.answer, 'bot');
                } else {
                    addMessage('é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'bot');
                }
            } catch (error) {
                console.error('API éŒ¯èª¤:', error);
                addMessage('é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'bot');
            }
        }
        
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            // å¾ URL åƒæ•¸å–å¾— JSON æ•¸æ“š
            const reportJson = urlParams.get('report');
            const reportData = JSON.parse(reportJson);

            // æ§‹å»ºç¬¬ä¸€æ¢è¨Šæ¯ï¼ŒåŒ…å« JSON æ•¸æ“š
            const initialQuery = `è«‹æ ¹æ“šé€™å€‹æ·±è¹²æ•¸æ“šåˆ†æï¼š${JSON.stringify(reportData, null, 2)}`;
            
            // é¡¯ç¤ºä½¿ç”¨è€…ç™¼é€çš„åˆå§‹ JSON è¨Šæ¯ï¼Œä¸¦ç™¼é€ API å‘¼å«
            addMessage(`æˆ‘çš„æ·±è¹²æ•¸æ“šï¼š\n${JSON.stringify(reportData, null, 2)}`, 'user');
            sendToBackend(initialQuery);
        };

        sendButton.addEventListener('click', () => {
            const userMessage = userInput.value.trim();
            if (userMessage) {
                addMessage(userMessage, 'user');
                sendToBackend(userMessage);
                userInput.value = '';
            }
        });
    </script>
        <h2>æ·±è¹²å½±ç‰‡</h2>
    <video width="720" height="480" controls>
        <source src="{{ url_for('static', filename=video_path) }}" type="video/mp4">
        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ’­æ”¾ã€‚
    </video>
    <h3>éŒ¯èª¤çš„æ·±è¹²ç•«é¢ï¼š</h3>
    <div>
        {% set error_images = error_images_json | from_json %}
        {% for item in error_images %}
        <div style="margin-bottom:20px;">
            <div style="font-weight:bold;">ç¬¬ {{ item.squat_id }} æ¬¡æ·±è¹²</div>
            <img src="{{ url_for('static', filename=item.img_path) }}" style="max-width:400px;">
        </div>
        {% endfor %}
    </div>
</body>
</html>