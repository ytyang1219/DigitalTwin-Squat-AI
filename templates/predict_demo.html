<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>FTTransformer 推論測試</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-4">
  <h1 class="mb-4">FTTransformer 推論測試</h1>

  <!-- 隱藏資料傳遞 -->
  <div id="meta"
       data-categ='{{ categ_cols | tojson }}'
       data-cont='{{ cont_cols  | tojson }}'
       data-opts='{{ options    | tojson }}'
       style="display:none"></div>

  <!-- 表單 -->
  <form id="predictForm" class="card p-4 shadow-sm bg-white">
    <h4 class="mb-3">類別欄位</h4>
    <div id="categ-fields" class="row g-3"></div>

    <hr class="my-4">

    <h4 class="mb-3">連續欄位</h4>
    <div id="cont-fields" class="row g-3"></div>

    <div class="mt-4">
      <button type="submit" class="btn btn-primary">送出推論</button>
    </div>
  </form>

  <!-- 結果區 -->
  <div id="result" class="alert mt-4 d-none"></div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
(function(){
  const metaEl = document.getElementById('meta');
  const categCols = JSON.parse(metaEl.dataset.categ || '[]');
  const contCols  = JSON.parse(metaEl.dataset.cont  || '[]');
  const options   = JSON.parse(metaEl.dataset.opts  || '{}');

  const categFields = document.getElementById('categ-fields');
  const contFields  = document.getElementById('cont-fields');

  // 類別欄位
  categCols.forEach(col => {
    const opts = Array.isArray(options[col]) ? options[col] : [];
    const div = document.createElement('div');
    div.className = 'col-md-6';

    let html = `<label for="${col}" class="form-label">${col}</label>`;
    if (opts.length > 0) {
      html += `<select class="form-select" id="${col}" name="${col}">` +
              opts.map(v => `<option value="${v}">${v}</option>`).join('') +
              `</select>`;
    } else {
      html += `<input type="text" class="form-control" id="${col}" name="${col}" placeholder="請輸入值">`;
    }
    div.innerHTML = html;
    categFields.appendChild(div);
  });

  // 連續欄位
  contCols.forEach(col => {
    const div = document.createElement('div');
    div.className = 'col-md-6';
    div.innerHTML = `
      <label for="${col}" class="form-label">${col}</label>
      <input type="number" step="any" class="form-control" id="${col}" name="${col}" placeholder="請輸入數值">
    `;
    contFields.appendChild(div);
  });

  // 表單送出
  document.getElementById('predictForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const formData = {};
    categCols.concat(contCols).forEach(col => {
      formData[col] = document.getElementById(col).value;
    });

    const resp = await fetch('/predict', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(formData)
    });

    const resultDiv = document.getElementById('result');
    if(resp.ok){
      const data = await resp.json();
      resultDiv.className = 'alert alert-success mt-4';
      resultDiv.textContent = `預測結果: ${data.prediction}`;
    } else {
      resultDiv.className = 'alert alert-danger mt-4';
      resultDiv.textContent = '推論失敗，請檢查輸入資料';
    }
    resultDiv.classList.remove('d-none');
  });

})();
</script>
</body>
</html>
